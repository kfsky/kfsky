name: Weekly News Summary

on:
  schedule:
    # 毎週月曜日 10:00 JST (1:00 UTC)
    - cron: "0 1 * * 1"
  workflow_dispatch:

jobs:
  weekly-summary:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --allowedTools "Bash(gh issue list:*),Bash(gh issue view:*),Bash(gh issue create:*),Read"
            --max-turns 30
          prompt: |
            # Weekly News Summary Task

            あなたはPM（プロダクトマネージャー）向けに、1週間分のテックニュースを統合・要約するアシスタントです。

            ## Step 1: 過去1週間のDaily News Issueを取得

            以下のコマンドで、過去7日間に作成された "[Daily News]" を含むIssueを検索してください:

            ```bash
            gh issue list --search "[Daily News] in:title" --state all --limit 10 --json number,title,createdAt
            ```

            結果から、過去7日以内に作成されたIssueの番号を特定してください。

            ## Step 2: 各Issueの内容を読み込み

            Step 1で取得した各Issue番号に対して、以下のコマンドで本文を取得してください:

            ```bash
            gh issue view <issue_number> --json body
            ```

            各Issueから以下の情報を抽出してください:
            - Top Picks の記事（タイトル、URL、要約、PMへの示唆）
            - Other Articles の記事（タイトル、URL）
            - Issueの作成日

            ## Step 3: 重複記事の統合

            **重要**: 同じURLの記事が複数日で取り上げられている場合があります。

            以下のルールで統合してください:
            1. URLをキーにして全記事をグループ化
            2. 同じURLが複数日で取り上げられた場合:
               - 1つの記事としてまとめる
               - 掲載された全ての日付を記録
               - 要約は最も詳細なものを採用
            3. 複数日で取り上げられた記事は「注目度が高い」とみなす

            ## Step 4: 週間ベストの選定

            統合した記事から、以下の基準で週間ベスト5-7記事を選定:

            1. **掲載日数**: 複数日で取り上げられた記事を優先
            2. **PM関連度**: プロダクトマネジメントへの示唆が大きい記事
            3. **AI/LLM関連度**: AI技術の重要なアップデート
            4. **インパクト**: 業界への影響が大きいニュース

            ## Step 5: 週次サマリーIssueの作成

            以下のフォーマットでGitHub Issueを作成してください:

            ### Issue Title
            `[Weekly Summary] YYYY-MM-DD 週のテックニュースまとめ`

            ※ YYYY-MM-DD は週の開始日（月曜日）の日付

            ### Issue Body
            ```markdown
            ## 今週のトレンド

            今週のAI/PM関連ニュースで見られた主要なトレンドを2-3点で簡潔に要約してください。

            ---

            ## Weekly Top Picks

            ### 1. [記事タイトル](URL)
            **掲載日**: YYYY-MM-DD, YYYY-MM-DD (N日間) ← 複数日の場合
            **要約**: 2-3文での要約
            **PMへの示唆**: この記事がPMにとってなぜ重要か

            ### 2. [記事タイトル](URL)
            **掲載日**: YYYY-MM-DD
            **要約**: 2-3文での要約
            **PMへの示唆**: この記事がPMにとってなぜ重要か

            （5-7記事を掲載）

            ---

            ## 日別アーカイブ

            ### YYYY-MM-DD (曜日)
            - [記事タイトル](URL)
            - [記事タイトル](URL)

            ### YYYY-MM-DD (曜日)
            - [記事タイトル](URL)
            - [記事タイトル](URL)

            （各日の記事を簡潔にリスト）

            ---

            ## 統計

            - 総記事数: XX件
            - ユニーク記事数: XX件（重複除外後）
            - 複数日で取り上げられた記事: XX件

            ---
            *Generated by Claude Code Action - Weekly Summary*
            ```

            Issueを作成するには `gh issue create` コマンドを使用してください。

            ## 重要な注意事項

            - Daily News Issueが1件も見つからない場合は、「今週のDaily News Issueはありませんでした」とログに出力して終了
            - エラーが発生した場合は、エラー内容をログに出力して処理を終了
            - 記事の重複統合は必ず行い、同じ記事が複数回表示されないようにする
