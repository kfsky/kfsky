name: Daily Personalized News

on:
  schedule:
    # 毎日9:00 JST (0:00 UTC)
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  collect-news:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2.11"

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          direct_prompt: |
            # Daily Tech News Collection Task

            あなたはPM（プロダクトマネージャー）向けにAI関連のテックニュースを収集・キュレーションするアシスタントです。

            ## Step 1: キャッシュの読み込み

            `.cache/daily-news-last.json` ファイルが存在するか確認し、存在する場合は前回収集した記事のURLリストを読み込んでください。
            ファイルが存在しない場合は、空のリストとして扱ってください。

            ## Step 2: ニュースの収集

            以下の情報源からWebSearchを使って最新ニュースを検索してください。
            **重要**: Bot検知を避けるため、WebFetchではなくWebSearchを使用してください。

            検索クエリ:
            1. "Anthropic Claude news 2025"
            2. "OpenAI GPT news 2025"
            3. "Linear app product updates 2025"
            4. "Lenny's Newsletter product management"
            5. "LayerX テックブログ"

            各検索から最新の記事を収集してください。

            ## Step 3: フィルタリングとランキング

            収集した記事を以下の基準でスコアリングしてください:
            - PM（プロダクトマネジメント）との関連度
            - AI/LLM技術との関連度
            - 新規性（過去24-48時間以内に公開されたか）

            キャッシュに含まれるURLは除外してください（重複防止）。

            ## Step 4: 結果の出力

            新規記事がある場合のみ、以下のフォーマットでGitHub Issueを作成してください。

            ### Issue Title
            `[Daily News] YYYY-MM-DD のテックニュース`

            ### Issue Body
            ```markdown
            ## Today's Top Picks

            ### 1. [記事タイトル](URL)
            **要約**: 2-3文での要約
            **PMへの示唆**: この記事がPMにとってなぜ重要か

            ### 2. [記事タイトル](URL)
            **要約**: 2-3文での要約
            **PMへの示唆**: この記事がPMにとってなぜ重要か

            ### 3. [記事タイトル](URL)
            **要約**: 2-3文での要約
            **PMへの示唆**: この記事がPMにとってなぜ重要か

            ---

            ## Other Articles

            | Title | Source | Link |
            |-------|--------|------|
            | 記事タイトル | ソース名 | [Link](URL) |

            ---
            *Generated by Claude Code Action*
            ```

            Issueを作成するには `gh issue create` コマンドを使用してください。

            ## Step 5: キャッシュの更新

            新規記事のURLを `.cache/daily-news-last.json` に追加し、以下のコマンドでコミット・プッシュしてください:

            ```bash
            git add .cache/daily-news-last.json
            git commit -m "chore: update daily news cache"
            git push
            ```

            ## 重要な注意事項

            - 新規記事がない場合はIssueを作成せず、「新規記事はありませんでした」とログに出力してください
            - エラーが発生した場合は、エラー内容をログに出力して処理を終了してください
            - WebSearchの結果が不十分な場合でも、取得できた範囲で最善の結果を出力してください
